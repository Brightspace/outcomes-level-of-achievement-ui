<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="squishy-button-selector/d2l-squishy-button-selector.html">
<link rel="import" href="squishy-button-selector/d2l-squishy-button.html">
<link rel="import" href="../d2l-polymer-siren-behaviors/store/entity-store.html">
<link rel="import" href="../d2l-polymer-siren-behaviors/store/entity-behavior.html">
<link rel="import" href="../d2l-polymer-siren-behaviors/store/siren-action-behavior.html">
<link rel="import" href="d2l-outcomes-loa-demonstration-level.html">

<!--
`d2l-outcomes-level-of-achievements`
Polymer Web-Component to display levels of achievements

@demo demo/d2l-outcomes-level-of-achievements.html
-->
<dom-module id="d2l-outcomes-level-of-achievements">
	<template strip-whitespace>
		<style>
			d2l-squishy-button-selector {
				width: 100%;
			}
		</style>

		<d2l-squishy-button-selector selected-index={{_selectedNum}}>
			<template is="dom-repeat" items="[[_getDemonstrationLevels(entity)]]">
				<d2l-squishy-button selected="[[item.selected]]" button-data=[[_getButtonData(item)]] style$="[[_getButtonStyle(item)]]">
					<d2l-outcomes-loa-demonstration-level href=[[item.entity]] token=[[token]]></d2l-outcomes-loa-demonstration-level>
				</d2l-squishy-button>
			</template>
		</d2l-squishy-button-selector>

	</template>
	<script>
		Polymer({
			is: 'd2l-outcomes-level-of-achievements',
			properties: {
				token: {
					type: String,
					value: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjJjMjdmNDlhLWZmZDMtNGI3Yi1iYTg5LWY3ODBmODBmZGY4NyJ9.eyJzdWIiOiIxNjkiLCJ0ZW5hbnRpZCI6IjJjMzhmM2RhLTRmY2MtNDYyOS05NzBhLWFlYzAzZjcyOTk2MCIsInNjb3BlIjoiKjoqOioiLCJqdGkiOiJiYzkxMWVlNS0yMzMwLTQ3NzktOGZlMS1hNjJhYTBmMDU5MzAiLCJpc3MiOiJodHRwczovL2FwaS5icmlnaHRzcGFjZS5jb20vYXV0aCIsImF1ZCI6Imh0dHBzOi8vYXBpLmJyaWdodHNwYWNlLmNvbS9hdXRoL3Rva2VuIiwiZXhwIjoxNTM5NzMyODI4LCJuYmYiOjE1Mzk3MjkyMjh9.e3U3bsECwCvFHVI0RJbb65rlWZTKwxX-cx9ohplrI4tv7JFcNnnc2rd-bwvMtB5nsTFMVsTFkDbWLq35kA0zLaItDQsJ4uh40l62hyCpxbtJIYhrsUdZ3mgSEzPMA2xy-7Rm34WhRBsIOhk5S5G0-Kb4S4U0WlKh9FWyL1PftxurI3bN2KcQtAlP7znBxQTaLzx-uyhkbm8Zj5ER-bErFfe2FH0_NzKQqCLJ8O6-rY3enTu4V1Dq1mrT2P1J8bGm3gBijeuJXWMzPvKkT5IfksUW2JCNhZQlOp0d0HhgVfGI4PRfM5T8m-Gvr9vASawro6MAIMnvHKrOf33LiokVKQ'
				},
				href: {
					type: String,
					value: 'https://2c38f3da-4fcc-4629-970a-aec03f729960.demonstrations.api.dev.brightspace.com/organizations/a5031d46-0461-462d-adc1-7851bfd7fe23/demonstrations/65e98c1e-9aab-42a6-bfc3-6e6306141dc0'
				},
				_selectedNum: Number
			},

			behaviors: [
				D2L.PolymerBehaviors.Siren.EntityBehavior,
				D2L.PolymerBehaviors.Siren.SirenActionBehavior
			],

			ready: function() {
				this._onItemSelected = this._onItemSelected.bind(this);
				this.$$('d2l-squishy-button-selector').addEventListener('d2l-squishy-button-selected', this._onItemSelected);
			},

			detached: function() {
				this.$$('d2l-squishy-button-selector').removeEventListener('d2l-squishy-button-selected', this._onItemSelected);
			},

			_getDemonstrationLevels: function(entity) {
				if (!entity) {
					return null;
				}
				var x = [];
				var selectedNum = null;

				var num = 0;
				entity.getSubEntitiesByClass('demonstratable-level').forEach(function(e) {
					var selected = e.hasClass('selected');
					x.push({
						entity: e.getLinkByRel('https://api.brightspace.com/rels/__todo_level').href,
						action: e.getActionByName('select'),
						selected: selected
					});
					if (e.hasClass('selected')) {
						selectedNum = num;
					}
					num++;
				});

				this._selectedNum = selectedNum;
				return x;
			},
			_getButtonData: function(item) {
				return {
					action: item.action
				};
			},
			_getButtonStyle: function(outcome) {
				return outcome.color ? '--d2l-squishy-button-selected-color: ' + outcome.color : '';
			},
			_onItemSelected: function(event) {
				var action = event.detail.data.action;
				if (!action) {
					return;
				}

				this.performSirenAction(action)
					.catch(function() {})
					.then(function() {
						window.D2L.Siren.EntityStore.fetch(this.href, this.token, true);
					}.bind(this));
			}
		});
	</script>
</dom-module>
